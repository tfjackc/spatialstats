---
title: "St. Louis Crime Analysis"
author: "Jack Colpitt"
date: "11/10/2023"
output:
    rmdformats::readthedown:
      self_contained: true
      thumbnails: false
      lightbox: true
      gallery: true
      highlight: tango
      always_allow_html: yes
      code_folding: hide
---

```{css, echo=FALSE}


h1 {
  color: black !important;
}

h2 {
  color: black !important;
  <!-- background-color:#ffeec5; -->
  <!-- padding: 5px; -->
  <!-- border-radius: 10px; -->
  <!-- border: 1px solid black; -->
}

#sidebar {
  background-color: black;
}

#sidebar h2 {
  background-color:#ffeec5;
  border-radius: 0px;
  border: 0px;
}

#sidebar h2 a {
  color:black;
}

#toc {
  background-color:black;
}

#postamble {
  border-top: black;
}
```

## Introduction

We will be analyzing a variety of recorded criminal activity in the St. Louis area. Particularly focusing on arson, DUIs, and homicides. Using a variety of statistical and mapping techniques we can answer questions, such as, "where did these crimes take place?" (Figure X.), "On average, how often are they happening?" (Figure 2 & Figure 3), and "Which crime is happening the most?" (Figure 1).

"be sure to include information on descriptive statistics and link it to the crime data you are using - include references"

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Required R Packages

The code cell below indicates the R packages used in the analysis.

```{r echo=TRUE, message = FALSE, class.source = 'fold-show'}
#install and load packages here
library(ggplot2)
library(maptools)
library (spatstat)
library(leaflet)
library (dplyr)
library(doBy)
library(rgdal)
library (ggmap)
library(gridExtra)
library(sp)
library (RColorBrewer)
library(DT)
```

## Methods

In our analysis we are leveraging statistics and visualization with the R programming language to gain an understanding of our chosen data set. The datatable shown in Table 1 allows us to preview the selected variables and observations. The table was filtered to show crime types, and frequency per month. Further insights are gained by showing trends in total number of crimes based on category (Figure 1) and crimes per month with an overlaid density curve in Figure 2. Figure 3 separates the data based on type, month, and year.

the sample mean of crime observations (Figure 2), and the interquartile range (Figure X). We can visualize the types of crime, how many times they've been observed, and what month, as well as pinpoints outliers in the data set that could potentially be skewing the data. 

## DataTable
```{r, echo=TRUE}
# set working directories
file_dir_crime <- "crime/"

# set other directories
file_dir_gis <- "gis/"

#read in crime file
#concatenate the filedircrime (set earlier to your directory) with the filename using paste()
crime_file <- paste(file_dir_crime,"crimeStLouis20132014b.csv", sep = "")
crime_file_agg <- paste(file_dir_crime,"crimeStLouis20132014b_agg.csv", sep = "")

# read data into csv 
crimesstl <- read.csv(crime_file, header=TRUE,sep=",")
crimesstl_agg <- read.csv(crime_file_agg, header=TRUE,sep=",") 
 
#create a list of the unique crime types in the data set and view what these are so that you can select using these so that you can explore their distributions.
listcrimetype <-unique(crimesstl$crimetype)

#returns a datatable of the loaded csv
sub_crime_agg <- crimesstl_agg %>%
  select(count, crimetype, month)

datatable(sub_crime_agg, width = "auto")
```
**Table 1.** By utilizing the datatable we can order count rate in a descending order and see that DUIs in May have the highest hit rate for a single crime type based on monthly intervals.

## What type of crimes occur more than others?

By summing the count column based on the type of crime we can visualize that arson occurs the most in comparison to DUIs and homicides. 

```{r echo=TRUE}
#Barchart of crimes by crimetype
counts <- table(crimesstl$crimetype)
barplot(counts, col = "cornflowerblue", main = "Number of Crimes by Crime Type", xlab="Crime Type", ylab="Number of Crimes")
```
**Figure 1.** Arson is the most common crime compared to the other attributes.

## Temporal patterns associated with each crime 

Now let's dive deeper into the data, and start to visualize information based on when it took place. 

```{r echo=TRUE}
#Histograms of crimes by observations per month
data <- c(table(crimesstl$month))
mean <- summarise(data)

ggplot(crimesstl, aes(x = month)) + 
  geom_histogram(binwidth = 1, fill = "grey", color = "black") +
  geom_density(aes(y = after_stat(count)), color = "red", size = 1) +
  labs(title = "Histogram of Crimes by Month with Density Curve",
       x = "Month",
       y = "Frequency") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_x_continuous(breaks = 2:12)
```
**Figure 2.** Most crimes took place in the month of August.

Utilizing a facet wrapped plot based on crime type we can see when each observation happens the most based on the month and also compare the years 2013 and 2014.

```{r echo=TRUE}
crimess2013 <- subset(crimesstl, year == "2013")
crimess2014 <- subset(crimesstl, year == "2014")

counts_2013 <- table(crimess2013$month, crimess2013$crimetype)
counts_df_2013 <- as.data.frame(counts_2013)
colnames(counts_df_2013) <- c("Month", "CrimeType", "Count")

# Create the faceted barplot
plot_2013 <- ggplot(counts_df_2013, aes(x = Month, y = Count, fill = CrimeType)) +
              geom_bar(stat = "identity", show.legend = FALSE) +
              labs(title = "2013",
                   x = "Month",
                   y = "Number of Crimes") +
              scale_fill_brewer(palette = "Set1") +  # You can change the palette if needed
              facet_wrap(~ CrimeType, scales = "free_x", ncol = 1)

counts_2014 <- table(crimess2014$month, crimess2014$crimetype)
counts_df_2014 <- as.data.frame(counts_2014)
colnames(counts_df_2014) <- c("Month", "CrimeType", "Count")

# Create the faceted barplot
plot_2014 <- ggplot(counts_df_2014, aes(x = Month, y = Count, fill = CrimeType)) +
              geom_bar(stat = "identity") +
              labs(title = "2014",
                   x = "Month",
                   y = "Number of Crimes") +
              scale_fill_brewer(palette = "Set1") +  # You can change the palette if needed
              facet_wrap(~ CrimeType, scales = "free_x", ncol = 1)

grid.arrange(plot_2013, plot_2014, nrow=1,ncol=2, widths = c(.75, 1))
```
**Figure 3.** Arson levels are heightened in August of 2013 and DUIs are hightened in April of 2014. The ggplot library and the facet_wrap() function was used to seperate the variables and visualize the information side by side. 

## Where did the crimes take place?

```{r echo=TRUE, message=FALSE, warning = FALSE}
#This will create a map with all of the points
gis_file <- paste(file_dir_gis,"stl_boundary_ll.shp", sep="")
#Read the St Louis Boundary Shapefile
StLouisBND <- readOGR(gis_file, layer = "stl_boundary_ll", GDAL1_integer64_policy = FALSE)

crimess22 <- subset(crimesstl, crimetype == "arson")
crimess33 <- subset(crimesstl, crimetype == "dui")
crimess44 <- subset(crimesstl, crimetype == "homicide")
#Create an interactive map for each crimetype
#To view a particular crime you will want to create a map using a subset of the data.
#Or use leaflet and include a background map to put the crime in context.
 
leaflet(crimesstl) %>%
  addTiles() %>%
  addPolygons(data=StLouisBND, 
              color = "#444444", 
              weight = 3, 
              smoothFactor = 0.5,
              opacity = 1.0, 
              fillOpacity = 0.5, 
              fill= FALSE,
              highlightOptions = highlightOptions(color = "white", weight = 2,
                                                      bringToFront = TRUE),
              group='St. Louis') %>%
   
  addCircles(data = crimess22, 
             lng = crimess22$xL, 
             lat = crimess22$yL, 
             weight = 5, 
             radius = 10,
             group = "Arson",
    popup = paste0("Crime type: ", as.character(crimess22$crimetype), 
                              "; Month: ", as.character(crimess22$month)))  %>%
 
 
#Turn these on when you are ready to view them. To do so remove the # and switch off the addCircles above by adding a #
  addCircles(data = crimess33, 
             lng = crimess33$xL, 
             lat = crimess33$yL, 
             weight = 5, 
             radius = 10,
             group = 'DUI',
      popup = paste0("Crime type: ", as.character(crimess33$crimetype), 
                                "; Month: ", as.character(crimess33$month)))  %>%
   
  addCircles(data = crimess44, 
             lng = crimess44$xL, 
             lat = crimess44$yL, 
             weight = 5, 
             radius = 10,
             group = 'Homicide',
      popup = paste0("Crime type: ", as.character(crimess44$crimetype), 
                                "; Month: ", as.character(crimess44$month)))  %>%

  addLayersControl(
          overlayGroups =c('St. Louis', 'Arson', 'DUI', 'Homicide'),
          options = layersControlOptions(collapsed=FALSE)
          )
```

## Descriptive Statistics 2.12

```{r echo=TRUE}
#BoxPlots are useful for comparing data. 
#Use the dataset crimeStLouis20132014b_agg.csv.  
#These data are aggregated by neighbourhood.  
agg_crime_file <-paste(file_dir_crime,"crimeStLouis20132014b_agg.csv", sep = "")
#check everything worked ok with accessing the file
#file.exists(agg_crime_file)
crimesstlagg <- read.csv(agg_crime_file, header=TRUE,sep=",")
 
#Compare crimetypes
boxplot(count~crimetype, data=crimesstlagg,main="Boxplots According to Crime Type",
            xlab="Crime Type", ylab="Number of Crimes",
            col="cornsilk", border="brown", pch=19)
```



```{r, echo = FALSE,fig.width = 10, fig.height=10}
stLbnd_df <- fortify(StLouisBND)

g1<-ggplot() +
      geom_polygon(data=stLbnd_df, aes(x=long, y=lat,group=group),color='black',linewidth = .2, fill=NA) +
      geom_point(data = crimesstl, aes(x = xL, y = yL),color = "black", size = 1) + ggtitle("All Crimes") +
      coord_fixed(1.3)+
  theme(panel.grid = element_blank())

g2<-ggplot() +
      geom_polygon(data=stLbnd_df, aes(x=long, y=lat,group=group),color='black',linewidth = .2, fill=NA) +
      geom_point(data = crimesstl, aes(x = xL, y = yL),color = "black", size = 1) + ggtitle("Crime Categories") +
      coord_fixed(1.3) +
  facet_wrap(~ crimetype)+
  theme(panel.grid = element_blank(),
        strip.text = element_text(size = 12)
        )

grid.arrange(g1, g2)
```


```{r}
summary(crimesstlagg)
```
